<!-- views/statistics.html - Complete Statistics Page (View Layer) -->
{% extends "base.html" %}

{% block title %}Statistics Dashboard - Crowdfunding Platform{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="row mb-4">
    <div class="col-12">
        <h1 class="display-5 fw-bold text-gradient-primary">
            <i class="bi bi-bar-chart-fill"></i>
            Platform Statistics Dashboard
        </h1>
        <p class="lead text-muted">Comprehensive analytics showing successful vs rejected pledges and platform performance</p>
    </div>
</div>

<!-- Key Metrics Cards Row -->
<div class="row mb-4">
    <!-- Successful Pledges -->
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card stats-card text-center pulse-on-hover">
            <div class="card-body">
                <i class="bi bi-check-circle-fill display-4 text-success mb-3"></i>
                <h2 class="text-success mb-2">{{ stats.total_successful_pledges }}</h2>
                <p class="text-muted mb-1">Successful Pledges</p>
                <small class="text-success">
                    <i class="bi bi-arrow-up"></i>
                    {{ stats.recent_successful_pledges }} this week
                </small>
            </div>
        </div>
    </div>
    
    <!-- Rejected Pledges -->
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card stats-card text-center pulse-on-hover">
            <div class="card-body">
                <i class="bi bi-x-circle-fill display-4 text-danger mb-3"></i>
                <h2 class="text-danger mb-2">{{ stats.total_rejected_pledges }}</h2>
                <p class="text-muted mb-1">Rejected Pledges</p>
                <small class="text-danger">
                    <i class="bi bi-arrow-down"></i>
                    {{ stats.recent_rejected_pledges }} this week
                </small>
            </div>
        </div>
    </div>
    
    <!-- Success Rate -->
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card stats-card text-center pulse-on-hover">
            <div class="card-body">
                <i class="bi bi-percent display-4 text-info mb-3"></i>
                <h2 class="text-info mb-2">{{ "%.1f"|format(stats.success_rate_percentage) }}%</h2>
                <p class="text-muted mb-1">Success Rate</p>
                <div class="progress mt-2" style="height: 8px;">
                    <div class="progress-bar bg-info" 
                         style="width: {{ stats.success_rate_percentage }}%"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Total Amount -->
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card stats-card text-center pulse-on-hover">
            <div class="card-body">
                <i class="bi bi-currency-dollar display-4 text-warning mb-3"></i>
                <h2 class="text-warning mb-2">${{ "{:,.0f}".format(stats.total_pledged_amount) }}</h2>
                <p class="text-muted mb-1">Total Pledged</p>
                <small class="text-warning">
                    Avg: ${{ "{:,.2f}".format(stats.average_pledge_amount) }}
                </small>
            </div>
        </div>
    </div>
</div>

<!-- Charts Section -->
<div class="row mb-4">
    <!-- Success Rate Chart -->
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-pie-chart-fill"></i>
                    Pledge Success vs Rejection Rate
                </h5>
            </div>
            <div class="card-body">
                <canvas id="successRateChart" width="400" height="250"></canvas>
                <div class="row mt-3 text-center">
                    <div class="col-6">
                        <h4 class="text-success">{{ stats.total_successful_pledges }}</h4>
                        <small class="text-muted">Successful</small>
                    </div>
                    <div class="col-6">
                        <h4 class="text-danger">{{ stats.total_rejected_pledges }}</h4>
                        <small class="text-muted">Rejected</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Project Status Chart -->
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-graph-up"></i>
                    Project Status Overview
                </h5>
            </div>
            <div class="card-body">
                <canvas id="projectStatusChart" width="400" height="250"></canvas>
                <div class="row mt-3 text-center">
                    <div class="col-4">
                        <h4 class="text-primary">{{ project_stats.total_projects }}</h4>
                        <small class="text-muted">Total</small>
                    </div>
                    <div class="col-4">
                        <h4 class="text-success">{{ project_stats.active_projects }}</h4>
                        <small class="text-muted">Active</small>
                    </div>
                    <div class="col-4">
                        <h4 class="text-warning">{{ project_stats.successful_projects }}</h4>
                        <small class="text-muted">Funded</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Rejection Analysis Section -->
<div class="row mb-4">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-exclamation-triangle"></i>
                    Pledge Rejection Reasons Analysis
                </h5>
            </div>
            <div class="card-body">
                {% if stats.top_rejection_reasons %}
                <div class="table-responsive">
                    <table class="table table-dark table-hover">
                        <thead>
                            <tr>
                                <th><i class="bi bi-list-ol"></i> Rank</th>
                                <th><i class="bi bi-exclamation-circle"></i> Rejection Reason</th>
                                <th><i class="bi bi-hash"></i> Count</th>
                                <th><i class="bi bi-percent"></i> Percentage</th>
                                <th><i class="bi bi-bar-chart"></i> Visual</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for reason, count in stats.top_rejection_reasons.items() %}
                            <tr>
                                <td>
                                    <span class="badge bg-secondary">{{ loop.index }}</span>
                                </td>
                                <td>
                                    <strong>{{ reason }}</strong>
                                </td>
                                <td>
                                    <span class="badge bg-danger">{{ count }}</span>
                                </td>
                                <td>
                                    <span class="text-warning">
                                        {{ "%.1f"|format((count / stats.total_rejected_pledges * 100) if stats.total_rejected_pledges > 0 else 0) }}%
                                    </span>
                                </td>
                                <td>
                                    <div class="progress" style="height: 20px; width: 150px;">
                                        <div class="progress-bar bg-danger" 
                                             style="width: {{ (count / stats.total_rejected_pledges * 100) if stats.total_rejected_pledges > 0 else 0 }}%">
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <i class="bi bi-check-circle display-1 text-success"></i>
                    <h3 class="mt-3 text-success">Perfect Success Rate!</h3>
                    <p class="text-muted">All pledges have been successful - no rejections recorded.</p>
                    <div class="alert alert-success mt-3">
                        <i class="bi bi-trophy"></i>
                        <strong>Congratulations!</strong> Your platform has a 100% success rate.
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Quick Stats Sidebar -->
    <div class="col-lg-4">
        <!-- Recent Activity Card -->
        <div class="card mb-3">
            <div class="card-header bg-info text-white">
                <h6 class="card-title mb-0">
                    <i class="bi bi-activity"></i>
                    Recent Activity (7 Days)
                </h6>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6 border-end">
                        <h3 class="text-success mb-1">{{ stats.recent_successful_pledges }}</h3>
                        <small class="text-muted">Successful</small>
                    </div>
                    <div class="col-6">
                        <h3 class="text-danger mb-1">{{ stats.recent_rejected_pledges }}</h3>
                        <small class="text-muted">Rejected</small>
                    </div>
                </div>
                <hr>
                <div class="text-center">
                    <h4 class="text-info">
                        {{ stats.recent_successful_pledges + stats.recent_rejected_pledges }}
                    </h4>
                    <small class="text-muted">Total Attempts</small>
                </div>
            </div>
        </div>
        
        <!-- System Overview Card -->
        <div class="card mb-3">
            <div class="card-header bg-primary text-white">
                <h6 class="card-title mb-0">
                    <i class="bi bi-gear"></i>
                    System Overview
                </h6>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <div class="d-flex justify-content-between mb-1">
                        <span class="text-muted">Total Users:</span>
                        <strong class="text-info">{{ user_stats.total_users }}</strong>
                    </div>
                    <div class="d-flex justify-content-between mb-1">
                        <span class="text-muted">Total Projects:</span>
                        <strong class="text-primary">{{ project_stats.total_projects }}</strong>
                    </div>
                    <div class="d-flex justify-content-between mb-1">
                        <span class="text-muted">Active Projects:</span>
                        <strong class="text-success">{{ project_stats.active_projects }}</strong>
                    </div>
                    <div class="d-flex justify-content-between mb-1">
                        <span class="text-muted">Platform Success:</span>
                        <strong class="text-warning">{{ "%.1f"|format(project_stats.success_rate) }}%</strong>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Average Statistics Card -->
        <div class="card">
            <div class="card-header bg-success text-white">
                <h6 class="card-title mb-0">
                    <i class="bi bi-calculator"></i>
                    Average Metrics
                </h6>
            </div>
            <div class="card-body">
                <div class="mb-2">
                    <div class="d-flex justify-content-between">
                        <span class="text-muted">Avg Pledge:</span>
                        <strong class="text-success">${{ "{:,.2f}".format(stats.average_pledge_amount) }}</strong>
                    </div>
                </div>
                <div class="mb-2">
                    <div class="d-flex justify-content-between">
                        <span class="text-muted">Total Attempts:</span>
                        <strong class="text-info">{{ stats.total_pledge_attempts }}</strong>
                    </div>
                </div>
                <div class="mb-2">
                    <div class="d-flex justify-content-between">
                        <span class="text-muted">Success Rate:</span>
                        <strong class="text-warning">{{ "%.1f"|format(stats.success_rate_percentage) }}%</strong>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Platform Health Indicator -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-speedometer2"></i>
                    Platform Health Indicator
                </h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    {% set health_score = (stats.success_rate_percentage + (project_stats.success_rate or 0)) / 2 %}
                    <div class="col-md-3">
                        <div class="{% if health_score >= 80 %}text-success{% elif health_score >= 60 %}text-warning{% else %}text-danger{% endif %}">
                            <i class="bi bi-{% if health_score >= 80 %}check-circle-fill{% elif health_score >= 60 %}exclamation-triangle-fill{% else %}x-circle-fill{% endif %} display-1"></i>
                            <h2 class="mt-2">{{ "%.0f"|format(health_score) }}%</h2>
                            <p class="mb-0">
                                {% if health_score >= 80 %}
                                    <span class="badge bg-success">Excellent</span>
                                {% elif health_score >= 60 %}
                                    <span class="badge bg-warning">Good</span>
                                {% else %}
                                    <span class="badge bg-danger">Needs Improvement</span>
                                {% endif %}
                            </p>
                        </div>
                    </div>
                    <div class="col-md-9">
                        <h4 class="text-start">Platform Performance Summary</h4>
                        <div class="text-start">
                            <p class="mb-2">
                                <i class="bi bi-arrow-right text-primary"></i>
                                <strong>Pledge Success Rate:</strong> {{ "%.1f"|format(stats.success_rate_percentage) }}% 
                                ({{ stats.total_successful_pledges }} successful out of {{ stats.total_pledge_attempts }} attempts)
                            </p>
                            <p class="mb-2">
                                <i class="bi bi-arrow-right text-info"></i>
                                <strong>Project Funding Success:</strong> {{ project_stats.successful_projects }} out of {{ project_stats.total_projects }} projects reached their goals
                            </p>
                            <p class="mb-2">
                                <i class="bi bi-arrow-right text-success"></i>
                                <strong>Active Projects:</strong> {{ project_stats.active_projects }} projects currently accepting pledges
                            </p>
                            <p class="mb-0">
                                <i class="bi bi-arrow-right text-warning"></i>
                                <strong>Total Funds Raised:</strong> ${{ "{:,.2f}".format(stats.total_pledged_amount) }} across all projects
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Chart.js Configuration for Statistics
document.addEventListener('DOMContentLoaded', function() {
    
    // Success Rate Pie Chart
    const successCtx = document.getElementById('successRateChart').getContext('2d');
    new Chart(successCtx, {
        type: 'doughnut',
        data: {
            labels: ['Successful Pledges', 'Rejected Pledges'],
            datasets: [{
                data: [{{ stats.total_successful_pledges }}, {{ stats.total_rejected_pledges }}],
                backgroundColor: [
                    'rgba(16, 185, 129, 0.8)',  // Success green
                    'rgba(239, 68, 68, 0.8)'    // Rejection red
                ],
                borderColor: [
                    'rgba(16, 185, 129, 1)',
                    'rgba(239, 68, 68, 1)'
                ],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        color: '#f9fafb',
                        padding: 20
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let total = context.dataset.data.reduce((a, b) => a + b, 0);
                            let percentage = ((context.raw / total) * 100).toFixed(1);
                            return context.label + ': ' + context.raw + ' (' + percentage + '%)';
                        }
                    }
                }
            }
        }
    });
    
    // Project Status Bar Chart
    const projectCtx = document.getElementById('projectStatusChart').getContext('2d');
    new Chart(projectCtx, {
        type: 'bar',
        data: {
            labels: ['Total Projects', 'Active Projects', 'Successful Projects', 'Expired Projects'],
            datasets: [{
                data: [
                    {{ project_stats.total_projects }},
                    {{ project_stats.active_projects }},
                    {{ project_stats.successful_projects }},
                    {{ project_stats.expired_projects }}
                ],
                backgroundColor: [
                    'rgba(59, 130, 246, 0.8)',   // Primary blue
                    'rgba(16, 185, 129, 0.8)',   // Success green
                    'rgba(245, 158, 11, 0.8)',   // Warning yellow
                    'rgba(239, 68, 68, 0.8)'     // Danger red
                ],
                borderColor: [
                    'rgba(59, 130, 246, 1)',
                    'rgba(16, 185, 129, 1)',
                    'rgba(245, 158, 11, 1)',
                    'rgba(239, 68, 68, 1)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        color: '#d1d5db'
                    },
                    grid: {
                        color: 'rgba(75, 85, 99, 0.3)'
                    }
                },
                x: {
                    ticks: {
                        color: '#d1d5db'
                    },
                    grid: {
                        color: 'rgba(75, 85, 99, 0.3)'
                    }
                }
            }
        }
    });
    
    // Auto-refresh statistics every 60 seconds
    setInterval(function() {
        // In a real application, this would fetch updated data
        console.log('Statistics auto-refresh (every 60 seconds)');
    }, 60000);
    
});
</script>
{% endblock %}